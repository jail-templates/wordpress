PKG curl

ARG MYSQL='/usr/local/bin/mysql'
ARG MYSQL_PASSWORD="$(openssl rand -base64 30 | tr -cd '[:alnum:]')"
ARG CURL='/usr/local/bin/curl '
ARG UNZIP='/usr/bin/unzip'

CMD ${MYSQL} -u root -e "CREATE DATABASE wordpress"
CMD ${MYSQL} -u root -e "CREATE USER wordpress"
CMD ${MYSQL} -u root -e "GRANT ALL PRIVILEGES ON wordpress.* TO wordpress@localhost IDENTIFIED BY '${MYSQL_PASSWORD}'"
CMD ${MYSQL} -u root -e "FLUSH PRIVILEGES"

CMD ${CURL} https://wordpress.org/latest.zip --output /tmp/latest.zip
CMD ${UNZIP} /tmp/latest.zip -d /usr/local/www

touch /usr/local/www/wordpress/wp-config.php
CMD chmod 440 /usr/local/www/wordpress/wp-config.php
CMD printf "<?php\n// ** Database settings ** //\n/** The name of the database for WordPress */\ndefine( 'DB_NAME', 'wordpress' );\n\n" > /usr/local/www/wordpress/wp-config.php
CMD printf "/** Database username */\ndefine( 'DB_USER', 'wordpress' );\n\n" >> /usr/local/www/wordpress/wp-config.php
CMD printf "/** Database password */\ndefine( 'DB_PASSWORD', '${MYSQL_PASSWORD}' );\n\n" >> /usr/local/www/wordpress/wp-config.php
CMD printf "/** Database hostname */\ndefine( 'DB_HOST', '127.0.0.1' );\n\n" >> /usr/local/www/wordpress/wp-config.php
CMD printf "/** Database charset to use in creating database tables. */\ndefine( 'DB_CHARSET', 'utf8mb4' );\n\n" >> /usr/local/www/wordpress/wp-config.php
CMD printf "/** The database collate type. Don't change this if in doubt. */\ndefine( 'DB_COLLATE', '' );\n\n" >> /usr/local/www/wordpress/wp-config.php
CMD printf "/**#@+\n * Authentication unique keys and salts.\n * Change these to different unique phrases! You can generate these using\n * the {@link https://api.wordpress.org/secret-key/1.1/salt/ WordPress.org secret-key service}.\n * You can change these at any point in time to invalidate all existing cookies.\n * This will force all users to have to log in again.\n */\n" >> /usr/local/www/wordpress/wp-config.php
CMD ${CURL} https://api.wordpress.org/secret-key/1.1/salt/ >> /usr/local/www/wordpress/wp-config.php
CMD printf "/**#@-*/\n\n" >> /usr/local/www/wordpress/wp-config.php
CMD printf "/* WordPress database table prefix. */\n$table_prefix = 'wp_';\n\n" >> /usr/local/www/wordpress/wp-config.php
CMD printf "/* For developers: WordPress debugging mode. */\ndefine( 'WP_DEBUG', false );\n\n" >> /usr/local/www/wordpress/wp-config.php
CMD printf "/* Add any custom values between this line and the 'stop editing' line. */\ndefine('FS_METHOD', 'direct');\n/* That's all, stop editing! Happy publishing. */\n\n" >> /usr/local/www/wordpress/wp-config.php
CMD printf "/** Absolute path to the WordPress directory. */\nif ( ! defined( 'ABSPATH' ) ) {\n        define( 'ABSPATH', __DIR__ . '/' );\n}\n\n" >> /usr/local/www/wordpress/wp-config.php
CMD printf "/** Sets up WordPress vars and included files. */\nrequire_once ABSPATH . 'wp-settings.php';\n\n" >> /usr/local/www/wordpress/wp-config.php

CMD touch /usr/local/www/wordpress/.htaccess
CMD chmod 444 /usr/local/www/wordpress/.htaccess
CMD chown -R www:www /usr/local/www/wordpress
CMD find /usr/local/www/wordpress -type d -exec chmod 755 {} \;
CMD find /usr/local/www/wordpress -type f -exec chmod 644 {} \;
